<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Loja Simples - PIX + Discord</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; max-width: 600px; margin: auto; }
  h1, h2 { text-align: center; }
  .produto { background: white; margin: 10px 0; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
  button { padding: 6px 12px; cursor: pointer; border: none; border-radius: 6px; background: #2b6cb0; color: white; }
  #adminPanel { background: white; padding: 15px; border-radius: 8px; margin: 20px 0; }
  input, label { display: block; margin: 8px 0; width: 100%; padding: 6px; font-size: 1rem; }
  #loginForm, #addProductForm { max-width: 400px; margin: 10px auto; }
  #loginForm input[type="password"] { max-width: 200px; }
  #logoutBtn { margin-top: 10px; background: #c53030; }
</style>
</head>
<body>

<h1>Loja Simples - PIX + Discord</h1>

<div id="userArea">
  <button id="loginBtn">Entrar Admin</button>
  <button id="logoutBtn" style="display:none;">Sair</button>
</div>

<div id="produtos"></div>

<div id="pixSection" style="text-align:center; margin-top:20px;">
  <h2>Pagamento via PIX</h2>
  <p>Chave PIX: <strong id="pixKey">franggg78@gmail.com</strong> <button id="copyPixBtn">Copiar PIX</button></p>
</div>

<div id="adminPanel" style="display:none;">
  <h2>Administra√ß√£o</h2>
  <form id="addProductForm">
    <input type="text" id="productName" placeholder="Nome do produto" required />
    <input type="number" id="productPrice" placeholder="Pre√ßo (R$)" min="0" step="0.01" required />
    <input type="number" id="productQty" placeholder="Quantidade" min="0" step="1" required />
    <button type="submit">Adicionar Produto</button>
  </form>
</div>

<div id="loginSection" style="display:none; text-align:center; margin:20px 0;">
  <form id="loginForm">
    <label>Senha Admin:</label>
    <input type="password" id="adminPassword" placeholder="Digite a senha" required />
    <button type="submit">Entrar</button>
  </form>
</div>

<script>
  const WEBHOOK_URL = "https://discord.com/api/webhooks/1404401043420348518/oBRaBa_7o-GhkdXUH4W62EnNzTwBERnbhw1ts3ySCvaaJ03hL5nnsvF2pi-TNVsCGVLC";
  const PIX_KEY = "franggg78@gmail.com";
  const ADMIN_PASS = "hkdonos1"; // troque para uma senha forte

  // Estado dos produtos salvo no localStorage
  let produtos = JSON.parse(localStorage.getItem("produtos")) || [
    { id: 1, nome: "Camiseta Exemplo", preco: 29.9, quantidade: 10 },
    { id: 2, nome: "Caneca Exemplo", preco: 19.9, quantidade: 20 }
  ];

  let isAdmin = false;

  const produtosDiv = document.getElementById("produtos");
  const loginSection = document.getElementById("loginSection");
  const adminPanel = document.getElementById("adminPanel");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const pixKeyEl = document.getElementById("pixKey");
  const copyPixBtn = document.getElementById("copyPixBtn");

  pixKeyEl.textContent = PIX_KEY;

  function salvarProdutos() {
    localStorage.setItem("produtos", JSON.stringify(produtos));
  }

  function renderProdutos() {
    produtosDiv.innerHTML = "";
    produtos.forEach(p => {
      const div = document.createElement("div");
      div.className = "produto";
      div.innerHTML = `
        <div>
          <strong>${p.nome}</strong><br>
          R$ ${p.preco.toFixed(2).replace(".", ",")}<br>
          Estoque: <span>${p.quantidade}</span>
        </div>
        <div>
          <button data-id="${p.id}" class="buyBtn" ${p.quantidade <= 0 ? "disabled" : ""}>Comprar</button>
          ${isAdmin ? `<button data-id="${p.id}" class="removeBtn" style="margin-left:5px; background:#c53030;">Remover</button>` : ""}
        </div>
      `;
      produtosDiv.appendChild(div);
    });

    // Eventos dos bot√µes
    document.querySelectorAll(".buyBtn").forEach(btn => {
      btn.onclick = () => comprarProduto(parseInt(btn.dataset.id));
    });

    if (isAdmin) {
      document.querySelectorAll(".removeBtn").forEach(btn => {
        btn.onclick = () => {
          if(confirm("Remover produto?")) {
            produtos = produtos.filter(p => p.id !== parseInt(btn.dataset.id));
            salvarProdutos();
            renderProdutos();
          }
        };
      });
    }
  }

  function comprarProduto(id) {
    const produto = produtos.find(p => p.id === id);
    if (!produto || produto.quantidade <= 0) {
      alert("Produto sem estoque!");
      return;
    }
    produto.quantidade--;
    salvarProdutos();
    renderProdutos();
    alert(`Obrigado pela compra! Pague via PIX: ${PIX_KEY}`);

    // Enviar notifica√ß√£o para Discord
    fetch(WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ content: `üõí Nova compra: ${produto.nome} - R$ ${produto.preco.toFixed(2).replace(".", ",")}` })
    }).catch(e => console.log("Erro ao enviar webhook:", e));
  }

  // Login / logout admin
  loginBtn.onclick = () => {
    loginSection.style.display = "block";
    loginBtn.style.display = "none";
  };

  logoutBtn.onclick = () => {
    isAdmin = false;
    loginSection.style.display = "none";
    adminPanel.style.display = "none";
    logoutBtn.style.display = "none";
    loginBtn.style.display = "inline-block";
    renderProdutos();
  };

  document.getElementById("loginForm").onsubmit = e => {
    e.preventDefault();
    const senha = document.getElementById("adminPassword").value;
    if (senha === ADMIN_PASS) {
      isAdmin = true;
      loginSection.style.display = "none";
      adminPanel.style.display = "block";
      logoutBtn.style.display = "inline-block";
      renderProdutos();
    } else {
      alert("Senha incorreta!");
    }
  };

  // Adicionar produto
  document.getElementById("addProductForm").onsubmit = e => {
    e.preventDefault();
    const nome = document.getElementById("productName").value.trim();
    const preco = parseFloat(document.getElementById("productPrice").value);
    const quantidade = parseInt(document.getElementById("productQty").value);

    if (!nome || preco <= 0 || quantidade < 0) {
      alert("Preencha todos os campos corretamente!");
      return;
    }

    const novoId = produtos.length ? Math.max(...produtos.map(p => p.id)) + 1 : 1;
    produtos.push({ id: novoId, nome, preco, quantidade });
    salvarProdutos();
    renderProdutos();

    // Reset form
    e.target.reset();
  };

  // Copiar PIX
  copyPixBtn.onclick = () => {
    navigator.clipboard.writeText(PIX_KEY).then(() => {
      alert("Chave PIX copiada!");
    }).catch(() => {
      alert("Erro ao copiar a chave PIX. Copie manualmente: " + PIX_KEY);
    });
  };

  // Inicializa a lista
  renderProdutos();
</script>

</body>
</html>
image?`<img src="${p.image}" alt="${p.name}" style="height:100%;object-fit:cover">`:'<div class="muted">Sem imagem</div>'}
      </div>
      <div class="product-title">${p.name}</div>
      <div class="muted">${currency(p.price)} ‚Ä¢ Estoque: <strong>${p.stock}</strong></div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <input type="number" min="1" max="${p.stock}" value="1" style="width:72px;padding:6px;border-radius:8px;border:1px solid #e6e9ef" id="q_${p.id}">
        <button class="btn" onclick="addToCart(${p.id})">Adicionar</button>
        <button class="btn ghost" onclick="viewProduct(${p.id})">Detalhes</button>
      </div>
    `
    el.appendChild(div)
  })
}

function renderCart(){
  const el = document.getElementById('cartList'); el.innerHTML=''
  if(cart.length===0){el.innerHTML='<div class="small">Seu carrinho est√° vazio</div>'; document.getElementById('totalValue').innerText=currency(0); return}
  let total=0
  cart.forEach(item=>{
    const p = products.find(x=>x.id===item.id)
    if(!p) return
    const row = document.createElement('div'); row.style.marginBottom='8px'
    row.innerHTML = `
      <div class="row">
        <div style="flex:1">
          <div style="font-weight:600">${p.name}</div>
          <div class="small">${currency(p.price)} x ${item.qty}</div>
        </div>
        <div style="text-align:right">
          <div>${currency(p.price*item.qty)}</div>
          <div style="margin-top:6px"><button class="btn ghost" onclick="removeFromCart(${item.id})">Remover</button></div>
        </div>
      </div>
    `
    el.appendChild(row)
    total += p.price * item.qty
  })
  document.getElementById('totalValue').innerText = currency(total)
}

// ======= a√ß√µes cart =======
function addToCart(id){
  const qtyInput = document.getElementById('q_'+id)
  let qty = Number(qtyInput?.value || 1)
  if(qty<=0) qty=1
  const p = products.find(x=>x.id===id)
  if(!p) return alert('Produto n√£o encontrado')
  if(qty>p.stock) return alert('Quantidade maior que o estoque')
  const exists = cart.find(x=>x.id===id)
  if(exists){
    if(exists.qty + qty > p.stock) return alert('Estoque insuficiente')
    exists.qty += qty
  } else cart.push({id,qty})
  persistCart(); renderCart()
}

function removeFromCart(id){ cart = cart.filter(x=>x.id!==id); persistCart(); renderCart() }

function persistCart(){ localStorage.setItem(LS_CART, JSON.stringify(cart)) }

// ======= checkout / PIX =======
function gerarTextoPIX(amount, key, receiver, reference){
  return `Pagamento via PIX
Chave: ${key}
Recebedor: ${receiver}
Valor: R$ ${Number(amount).toFixed(2)}
Refer√™ncia: ${reference}`
}

function generatePIXQr(data){
  const url = 'https://api.qrserver.com/v1/create-qr-code/?size=260x260&data=' + encodeURIComponent(data)
  return url
}

function checkoutPrepare(){
  if(cart.length===0) return alert('Carrinho vazio')
  const total = cart.reduce((s,it)=>{
    const p = products.find(x=>x.id===it.id); return s + (p? p.price*it.qty:0)
  },0)
  const key = storeCfg.pixKey || ''
  const receiver = storeCfg.receiverName || ''
  const reference = 'PED-' + Date.now()
  const text = gerarTextoPIX(total, key, receiver, reference)
  const qr = generatePIXQr(text)
  const area = document.getElementById('pixArea')
  area.style.display='block'
  area.innerHTML = `
    <div style="text-align:center">
      <div style="font-weight:600">Pagar com PIX</div>
      <img src="${qr}" alt="QR PIX" style="margin:8px 0;border-radius:8px">
      <div class="small">Chave: <strong>${key}</strong></div>
      <div class="small">Valor: <strong>${currency(total)}</strong></div>
      <div class="small">Refer√™ncia: <strong>${reference}</strong></div>
      <div style="margin-top:8px"><button class="btn" onclick="copiarTexto('${escapeHtml(text)}')">Copiar instru√ß√µes</button></div>
      <div style="margin-top:8px" class="small">Depois de pagar, confirme manualmente o pedido com o vendedor (este demo n√£o faz concilia√ß√£o autom√°tica).</div>
    </div>
  `
}

function copiarTexto(t){ const textarea = document.createElement('textarea'); textarea.value = unescapeHtml(t); document.body.appendChild(textarea); textarea.select(); document.execCommand('copy'); textarea.remove(); alert('Instru√ß√µes copiadas para a √°rea de transfer√™ncia') }

function escapeHtml(s){ return s.replace(/'/g, "\'").replace(/
/g,'\n') }
function unescapeHtml(s){ return s }

// ======= admin =======
function renderAdminProducts(){
  const el = document.getElementById('adminProductsList')
  el.innerHTML = ''
  if(products.length === 0){
    el.innerHTML = '<div class="small">Nenhum produto cadastrado.</div>'
    return
  }
  products.forEach(p=>{
    const row = document.createElement('div')
    row.className = 'product-row'
    row.innerHTML = `
      <input type="text" value="${p.name}" id="admName_${p.id}" placeholder="Nome" />
      <input type="number" step="0.01" min="0" value="${p.price}" id="admPrice_${p.id}" placeholder="Pre√ßo" style="max-width:80px" />
      <input type="number" min="0" value="${p.stock}" id="admStock_${p.id}" placeholder="Estoque" style="max-width:70px" />
      <input type="text" value="${p.image}" id="admImage_${p.id}" placeholder="URL da imagem" />
      <button class="btn ghost" onclick="updateProduct(${p.id})" title="Salvar">Salvar</button>
      <button class="btn ghost" style="color:#d00;border-color:#d00" onclick="deleteProduct(${p.id})" title="Excluir">Excluir</button>
    `
    el.appendChild(row)
  })
}

function updateProduct(id){
  const name = document.getElementById('admName_'+id).value.trim()
  const price = parseFloat(document.getElementById('admPrice_'+id).value.replace(',','.'))
  const stock = parseInt(document.getElementById('admStock_'+id).value)
  const image = document.getElementById('admImage_'+id).value.trim()
  if(!name || isNaN(price) || isNaN(stock)){
    alert('Preencha nome, pre√ßo e estoque corretamente para salvar.')
    return
  }
  const prodIndex = products.findIndex(p=>p.id===id)
  if(prodIndex === -1) return alert('Produto n√£o encontrado')
  products[prodIndex] = {id, name, price, stock, image}
  localStorage.setItem(LS_PRODUCTS, JSON.stringify(products))
  renderProducts()
  renderAdminProducts()
  alert('Produto atualizado.')
}

function deleteProduct(id){
  if(!confirm('Tem certeza que deseja excluir este produto?')) return
  products = products.filter(p=>p.id!==id)
  localStorage.setItem(LS_PRODUCTS, JSON.stringify(products))
  renderProducts()
  renderAdminProducts()
  alert('Produto exclu√≠do.')
}

function showLoginPanel(){
  document.getElementById('adminPanel').style.display = 'block'
  document.getElementById('loginPanel').style.display = 'block'
  document.getElementById('adminContent').style.display = 'none'
  document.getElementById('btnAdminToggle').innerText = 'Entrar como Admin'
}

function loginAdmin(){
  const user = document.getElementById('loginUser').value.trim()
  const pass = document.getElementById('loginPass').value
  if(user === adminUser && pass === adminPassword){
    isAdmin = true
    localStorage.setItem(LS_ADMIN, 'true')
    document.getElementById('modeLabel').innerText = 'Admin'
    document.getElementById('loginUser').value = ''
    document.getElementById('loginPass').value = ''
    document.getElementById('loginPanel').style.display = 'none'
    document.getElementById('adminContent').style.display = 'block'
    document.getElementById('btnAdminToggle').innerText = 'Painel aberto'
    renderAdminProducts()
    loadAdminValues()
  } else {
    alert('Credenciais incorretas.')
  }
}

function logoutAdmin(){
  isAdmin = false
  localStorage.removeItem(LS_ADMIN)
  document.getElementById('adminPanel').style.display = 'none'
  document.getElementById('modeLabel').innerText = 'Vis√£o p√∫blica'
  document.getElementById('btnAdminToggle').innerText = 'Entrar como Admin'
}

function toggleAdmin(){
  const panel = document.getElementById('adminPanel')
  if(!panel) return
  if(panel.style.display === 'block'){
    panel.style.display = 'none'
    return
  }
  // show panel; if already logged in, show admin content
  panel.style.display = 'block'
  if(isAdmin){
    document.getElementById('loginPanel').style.display = 'none'
    document.getElementById('adminContent').style.display = 'block'
    document.getElementById('btnAdminToggle').innerText = 'Painel aberto'
    document.getElementById('modeLabel').innerText = 'Admin'
    renderAdminProducts(); loadAdminValues()
  } else {
    document.getElementById('loginPanel').style.display = 'block'
    document.getElementById('adminContent').style.display = 'none'
    document.getElementById('btnAdminToggle').innerText = 'Entrar como Admin'
  }
}

function loadAdminValues(){
  document.getElementById('pixKey').value = storeCfg.pixKey || ''
  document.getElementById('receiverName').value = storeCfg.receiverName || ''
}

function addOrUpdateProduct(){
  const name = document.getElementById('pName').value.trim();
  const price = parseFloat(document.getElementById('pPrice').value.replace(',','.'))
  const stock = parseInt(document.getElementById('pStock').value)
  const image = document.getElementById('pImage').value.trim()
  if(!name || isNaN(price) || isNaN(stock)) return alert('Preencha nome, pre√ßo e estoque corretamente')
  const nextId = products.length? Math.max(...products.map(p=>p.id))+1:1
  const prod = {id: nextId,name,price,stock,image}
  products.push(prod)
  localStorage.setItem(LS_PRODUCTS, JSON.stringify(products))
  renderProducts()
  renderAdminProducts()
  alert('Produto adicionado')
  document.getElementById('pName').value=''; document.getElementById('pPrice').value=''; document.getElementById('pStock').value=''; document.getElementById('pImage').value=''
}

function saveStoreCfg(){
  storeCfg.pixKey = document.getElementById('pixKey').value.trim()
  storeCfg.receiverName = document.getElementById('receiverName').value.trim()
  localStorage.setItem(LS_STORE, JSON.stringify(storeCfg))
  alert('Configura√ß√µes salvas')
}

// small product viewer
function viewProduct(id){
  const p = products.find(x=>x.id===id)
  if(!p) return
  alert(`${p.name}
Pre√ßo: ${currency(p.price)}
Estoque: ${p.stock}`)
}

// bind events
document.getElementById('btnAdminToggle').addEventListener('click', toggleAdmin)
document.getElementById('btnAddProduct').addEventListener('click', addOrUpdateProduct)
document.getElementById('btnLogoutAdmin').addEventListener('click', logoutAdmin)
document.getElementById('btnCheckout').addEventListener('click', checkoutPrepare)
document.getElementById('pixKey').addEventListener('blur', saveStoreCfg)
document.getElementById('receiverName').addEventListener('blur', saveStoreCfg)
document.getElementById('btnLogin').addEventListener('click', loginAdmin)
document.getElementById('btnSaveStoreCfg').addEventListener('click', saveStoreCfg)

// initial render
renderProducts(); renderCart();
if(isAdmin){
  document.getElementById('adminPanel').style.display = 'block'
  document.getElementById('adminContent').style.display = 'block'
  document.getElementById('loginPanel').style.display = 'none'
  document.getElementById('modeLabel').innerText = 'Admin'
  document.getElementById('btnAdminToggle').innerText = 'Painel aberto'
  renderAdminProducts(); loadAdminValues()
}

</script>
</body>
</html>
